<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caro's Pizzeria</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    :root { --primary-red:#E31837; --dark-red:#C41230; --cream:#FFF8E7; }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Georgia,serif;line-height:1.6;background:var(--cream);color:#222}
    .shell{max-width:1000px;margin:0 auto;padding:0 1rem}
    .header{padding:2rem 0 1rem;text-align:center}
    .logo{max-width:420px;width:90%;margin:1rem auto;display:block}

    /* HERO DROP */
    #drop{background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.08);
          padding:1.1rem; margin:1rem auto 2rem; position:sticky; top:0; z-index:10}
    #drop h2{color:var(--dark-red); text-align:center; font-size:1.35rem; margin-bottom:.35rem}
    #dropStatus{ text-align:center; margin:.25rem 0 .75rem; font-size:1.05rem }
    #dropStatus strong{ font-size:1.2rem }
    .muted{color:#6b7280}
    .row{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
    select{padding:.6rem .7rem; border:1px solid #ddd; border-radius:8px; background:#fff}
    .order-button{
      background:var(--primary-red); color:#fff; border:none; padding:1rem 1.25rem;
      border-radius:8px; font-weight:800; cursor:pointer; box-shadow:0 6px 14px rgba(227,24,55,.25);
      transition:.15s; width:100%; letter-spacing:.2px
    }
    .order-button[disabled]{opacity:.6; cursor:not-allowed}
    .order-button:hover{background:var(--dark-red); transform:translateY(-1px)}

    /* SECTIONS */
    .section{background:#fff; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,.06);
             padding:1.2rem; margin:0 auto 1.2rem}
    .section h3{color:var(--dark-red); text-align:center; margin-bottom:.5rem}
    .menu-item{background:#FFF4EF; border-radius:8px; padding:1rem; margin:.5rem 0}
    .menu-item strong{display:block; margin-bottom:.25rem}

    /* Contacts (de-emphasized) */
    .contacts{display:flex; gap:.75rem; justify-content:center; flex-wrap:wrap; margin-top:.8rem}
    .btn-secondary{display:inline-flex; align-items:center; gap:.4rem; padding:.5rem .9rem;
      border:2px solid #bbb; border-radius:6px; color:#666; text-decoration:none; font-weight:600}
    .btn-secondary:hover{background:#666; color:#fff}

    @media (max-width:640px){
      #drop{margin:0 .25rem 1rem}
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="header">
      <img src="carospizzerialogo.png" class="logo" alt="Caroâ€™s Pizzeria">
    </header>

    <!-- HERO: Todayâ€™s Drop -->
    <div id="drop" class="section">
      <h2>ðŸ”¥ Todayâ€™s Pizza Drop</h2>
      <div id="dropStatus" class="muted">Checking availabilityâ€¦</div>

      <div class="row" style="gap:.5rem;margin:.25rem 0 .5rem">
        <!-- Topping -->
        <select id="topping" aria-label="Choose pie">
          <option value="cheese">Gigi Style Cheese Pie</option>
          <option value="pepperoni">Beebop Style Pepperoni</option>
        </select>

        <!-- Qty -->
        <select id="qty" aria-label="Quantity">
          <option>1</option><option>2</option><option>3</option><option>4</option>
        </select>

        <!-- Slot -->
        <select id="slot" aria-label="Pickup time">
          <option value="">Select time</option>
        </select>
      </div>

      <button id="buyBtn" class="order-button" disabled>GET YOUR PIE</button>
      <div class="muted" style="margin-top:.6rem; text-align:center">
        Pay with card, Apple Pay, or Google Pay. <strong>Tax added at checkout.</strong>
      </div>
    </div>

    <!-- Menu / Story -->
    <div class="section">
      <h3>Our Pies</h3>

      <div class="menu-item">
        <strong>Gigi Style Cheese Pie</strong>
        <p>Great-great-great grandmaâ€™s Northern Italian method â€” the original South Carolinaâ€“style pizza pie.</p>
      </div>
      <div class="menu-item">
        <strong>Beebop Style Pepperoni</strong>
        <p>Everything in the Cheese â€” plus pepperoni.</p>
      </div>

      <div class="contacts">
        <div class="muted" style="width:100%; text-align:center; margin-bottom:.25rem">
          Ordering is <strong>online only</strong>. Questions? You can still text or call:
        </div>
        <a href="sms:5052264632?body=Hey!%20Ordering%20is%20online%20only.%20Snag%20your%20pie%20at%20carospizzeria.com" class="btn-secondary">ðŸ’¬ Text</a>
        <a href="tel:5052264632" class="btn-secondary">ðŸ“ž Call</a>
      </div>
    </div>

    <footer class="section" style="text-align:center">
      <small>Â© 2025 Caroâ€™s Pizzeria. Made with love.</small>
    </footer>
  </div>

  <script>
    // Your published Apps Script URL:
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbz_dg9SuXT6n19We1l2lw5tuKiwolITeJ7N4ayei4qWHC2VG41ERO7nrZIMb2dqLhCT/exec';

    function parseTime12h_(s){
      const m = s.trim().match(/^(\d{1,2}):(\d{2})\s*([ap]m)$/i);
      if(!m) return null;
      let h = Number(m[1]) % 12; if (m[3].toLowerCase()==='pm') h += 12;
      const d = new Date(); d.setHours(h, Number(m[2]), 0, 0); return d;
    }
    function populateSlotsFromWindow(winStr, stepMinutes=15){
      const sel = document.getElementById('slot');
      sel.innerHTML = '<option value="">Select time</option>';
      const parts = (winStr||'').split('-'); if (parts.length!==2) return;
      const start = parseTime12h_(parts[0]); const end = parseTime12h_(parts[1]); if(!start || !end) return;
      const d = new Date(start);
      while (d < end){
        const e = new Date(d.getTime() + stepMinutes*60000);
        const label = d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}) + 'â€“' +
                      e.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
        const opt = document.createElement('option'); opt.value = label; opt.textContent = label;
        sel.appendChild(opt); d.setTime(e.getTime());
      }
    }
    function todayIsoLocal(){
      const t=new Date(), y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    async function loadDropStatus(){
      const S = document.getElementById('dropStatus');
      const B = document.getElementById('buyBtn');

      try{
        const r = await fetch(GAS_URL+'?route=status');
        const d = await r.json();

        if (!d.ok || !d.active){
          S.innerHTML = '<strong>Sold out</strong> or no drop scheduled.';
          B.disabled = true; B.textContent = 'UNAVAILABLE'; return;
        }

        // Window & slots
        populateSlotsFromWindow(d.pickup_window, 15);

        // Remaining (smart label)
        const isToday = d.date_iso === todayIsoLocal();
        const when = isToday
          ? 'today'
          : new Date(d.date_iso+'T00:00:00').toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
        S.innerHTML = `<strong>${d.remaining}</strong> left ${isToday ? 'today' : 'for '+when} <span class="muted">(${d.pickup_window})</span>`;

        if (d.soldOut){ B.disabled = true; B.textContent = 'SOLD OUT'; return; }

        // Cap qty by remaining
        const qtySel = document.getElementById('qty');
        [...qtySel.options].forEach(opt => { opt.disabled = Number(opt.value) > d.remaining; });
        qtySel.value = Math.min(Number(qtySel.value), d.remaining || 1);

        // Disable topping if not offered
        const topSel = document.getElementById('topping');
        if (!d.variants?.pepperoni) [...topSel.options].forEach(o => o.value==='pepperoni' && (o.disabled=true));
        if (!d.variants?.cheese)    [...topSel.options].forEach(o => o.value==='cheese'    && (o.disabled=true));

        B.disabled = false; B.textContent = 'GET YOUR PIE';
      } catch(e){
        S.textContent = 'Error loading drop.'; B.disabled = true; B.textContent = 'ERROR';
      }
    }

    async function startCheckout(){
      const B = document.getElementById('buyBtn');
      const qty = Number(document.getElementById('qty').value);
      const topping = document.getElementById('topping').value;
      const pickup_slot = document.getElementById('slot').value || '';
      if (!pickup_slot){ alert('Please choose a pickup time.'); return; }

      B.disabled = true; B.textContent = 'Redirectingâ€¦';
      try{
        const r = await fetch(GAS_URL+'?route=create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ quantity:String(qty), topping, pickup_slot })
        });
        const d = await r.json();
        if (d.ok && d.url){ window.location = d.url; }
        else{
          if (d.error === 'SOLD_OUT_OR_SHORT'){
            const rem = Number(d.remaining ?? 0);
            if (rem > 0){
              const qtySel = document.getElementById('qty');
              [...qtySel.options].forEach(opt => { opt.disabled = Number(opt.value) > rem; });
              qtySel.value = Math.min(Number(qtySel.value), rem);
              alert(`Only ${rem} left. Quantity adjusted.`);
            } else { alert('Looks like it just sold out.'); }
          } else { alert(d.message || d.error || 'Could not start checkout.'); }
          await loadDropStatus();
          B.disabled = false; B.textContent = 'GET YOUR PIE';
        }
      } catch(e){
        alert('Checkout error. Please refresh and try again.');
        B.disabled = false; B.textContent = 'GET YOUR PIE';
      }
    }

    document.getElementById('buyBtn').addEventListener('click', startCheckout);
    loadDropStatus();
    setInterval(loadDropStatus, 30000); // keep remaining fresh
  </script>
</body>
</html>
